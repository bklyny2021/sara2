<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üåü Sara Autonomous - Full Streaming AI</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #4a5568 0%, #2d3748 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .header {
            background: rgba(74, 85, 104, 0.5);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(74, 85, 104, 0.8);
            padding: 1rem 2rem;
            color: #e2e8f0;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .header .mode-badge {
            background: rgba(102, 126, 234, 0.6);
            border: 1px solid rgba(102, 126, 234, 0.8);
            border-radius: 20px;
            padding: 0.25rem 0.75rem;
            font-size: 0.8rem;
            color: #e2e8f0;
            margin-left: 1rem;
        }

        .main-container {
            flex: 1;
            display: flex;
            max-width: 1200px;
            width: 100%;
            margin: 0 auto;
            padding: 2rem;
            gap: 2rem;
        }

        .chat-container {
            flex: 1;
            background: rgba(45, 55, 72, 0.7);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 2px solid rgba(74, 85, 104, 0.8);
            display: flex;
            flex-direction: column;
            max-height: 80vh;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 2rem 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 80%;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message.user {
            margin-left: auto;
            flex-direction: row-reverse;
        }

        .message.sara {
            margin-right: auto;
        }

        .avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            font-weight: 600;
            flex-shrink: 0;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.15);
        }

        .avatar.user {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: #ffffff;
            border: 2px solid rgba(66, 153, 225, 0.3);
        }

        .avatar.sara {
            background: linear-gradient(135deg, #667eea, #5a67d8);
            color: #ffffff;
            border: 2px solid rgba(102, 126, 234, 0.3);
        }

        .message-content {
            background: rgba(74, 85, 104, 0.4);
            backdrop-filter: blur(8px);
            border-radius: 18px 18px 18px 4px;
            padding: 1rem 1.2rem;
            color: #e2e8f0;
            line-height: 1.5;
            word-wrap: break-word;
            border: 1px solid rgba(74, 85, 104, 0.6);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            font-size: 0.95rem;
            position: relative;
        }

        .message.user .message-content {
            background: rgba(66, 153, 225, 0.25);
            border: 1px solid rgba(66, 153, 225, 0.4);
            border-radius: 18px 18px 4px 18px;
        }

        .thinking-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin: 0.5rem 0;
            padding: 0.5rem;
            background: rgba(102, 126, 234, 0.1);
            border-radius: 10px;
            font-size: 0.85rem;
            color: #a0aec0;
            font-style: italic;
        }

        .thinking-dots {
            display: flex;
            gap: 0.25rem;
        }

        .thinking-dot {
            width: 6px;
            height: 6px;
            background: #8b9dc3;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }

        .thinking-dot:nth-child(1) { animation-delay: -0.32s; }
        .thinking-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1.0); }
        }

        .streaming-controls {
            border-top: 2px solid rgba(74, 85, 104, 0.8);
            padding: 1rem;
            display: flex;
            gap: 1rem;
            align-items: center;
        }

        .message-input-wrapper {
            flex: 1;
            position: relative;
        }

        .message-input {
            width: 100%;
            background: rgba(74, 85, 104, 0.3);
            border: 2px solid rgba(74, 85, 104, 0.6);
            border-radius: 25px;
            padding: 0.75rem 1rem;
            color: #e2e8f0;
            font-size: 0.9rem;
            outline: none;
            transition: all 0.3s ease;
        }

        .message-input::placeholder {
            color: rgba(160, 174, 192, 0.8);
        }

        .message-input:focus {
            background: rgba(74, 85, 104, 0.4);
            border-color: #4299e1;
        }

        .send-button, .stop-button {
            background: rgba(102, 126, 234, 0.6);
            border: 2px solid rgba(102, 126, 234, 0.8);
            border-radius: 50%;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #e2e8f0;
            font-size: 1.2rem;
        }

        .send-button:hover:not(:disabled) {
            background: rgba(102, 126, 234, 0.8);
            transform: scale(1.05);
        }

        .send-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .stop-button {
            background: rgba(239, 68, 68, 0.6);
            border: 2px solid rgba(239, 68, 68, 0.8);
        }

        .stop-button:hover:not(:disabled) {
            background: rgba(239, 68, 68, 0.8);
            transform: scale(1.05);
        }

        .status-panel {
            background: rgba(74, 85, 104, 0.3);
            padding: 1rem;
            border-radius: 10px;
            margin-top: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.85rem;
            color: #e2e8f0;
        }

        .sidebar {
            width: 250px;
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .status-card, .capabilities-card {
            background: rgba(45, 55, 72, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            border: 2px solid rgba(74, 85, 104, 0.8);
            padding: 1.25rem;
            color: #e2e8f0;
        }

        .card-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 1rem;
            opacity: 0.9;
        }

        .capability-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            font-size: 0.85rem;
        }

        .streaming-indicator {
            color: #68d391;
            font-size: 0.75rem;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .completions {
            background: rgba(102, 126, 234, 0.1);
            border-left: 3px solid #667eea;
            padding: 0.75rem;
            margin: 0.5rem 0;
            border-radius: 5px;
            font-style: italic;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
                padding: 1rem;
            }
            
            .sidebar {
                width: 100%;
                flex-direction: row;
                overflow-x: auto;
            }
            
            .message {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <h1>üåü Sara Autonomous<span class="mode-badge">STREAMING MODE</span></h1>
    </header>

    <div class="main-container">
        <div class="chat-container">
            <div class="messages-container" id="messagesContainer">
                <!-- Messages will appear here -->
            </div>

            <div class="streaming-controls">
                <div class="message-input-wrapper">
                    <input type="text" class="message-input" id="messageInput" 
                           placeholder="Ask Sara anything - she'll respond autonomously..." />
                </div>
                <button class="send-button" id="sendButton" title="Send message">‚û§</button>
                <button class="stop-button" id="stopButton" title="Stop Sara's response" disabled>‚èπ</button>
            </div>

            <div class="status-panel" id="statusPanel">
                <div class="status-item">
                    <span class="streaming-indicator" id="streamingStatus">ü§ñ Ready</span>
                    <span id="statusText">Sara is ready to chat</span>
                </div>
            </div>
        </div>

        <div class="sidebar">
            <div class="status-card">
                <div class="card-title">ü§ñ Autonomous Features</div>
                <div class="status-item">‚úÖ Full streaming responses</div>
                <div class="status-item">‚úÖ Background thinking</div>
                <div class="status-item">‚úÖ Stop/pause controls</div>
                <div class="status-item">‚úÖ Self-completion</div>
            </div>

            <div class="capabilities-card">
                <div class="card-title">üéØ Sara Capabilities</div>
                <div class="capability-item">üíª Complete system access</div>
                <div class="capability-item">üß† Strategic thinking</div>
                <div class="capability-item">üîê Security expertise</div>
                <div class="capability-item">üó£Ô∏è Voice synthesis</div>
                <div class="capability-item">üìã Task automation</div>
            </div>
        </div>
    </div>

    <script>
        class SaraAutonomousChat {
            constructor() {
                this.messagesContainer = document.getElementById('messagesContainer');
                this.messageInput = document.getElementById('messageInput');
                this.sendButton = document.getElementById('sendButton');
                this.stopButton = document.getElementById('stopButton');
                this.statusText = document.getElementById('statusText');
                this.streamingStatus = document.getElementById('streamingStatus');
                
                this.isStreaming = false;
                this.eventSource = null;
                this.currentMessageElement = null;
                
                this.initEventListeners();
                this.addWelcomeMessage();
            }

            initEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.stopButton.addEventListener('click', () => this.stopResponse());
                this.messageInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.sendMessage();
                });
            }

            async sendMessage() {
                const message = this.messageInput.value.trim();
                if (!message || this.isStreaming) return;

                // Add user message
                this.addMessage('user', message);
                this.messageInput.value = '';

                // Start streaming response
                await this.startStreaming(message);
            }

            async startStreaming(message) {
                this.isStreaming = true;
                this.sendButton.disabled = true;
                this.stopButton.disabled = false;
                this.streamingStatus.textContent = 'ü§ñ Responding...';
                this.statusText.textContent = 'Sara is thinking and responding...';

                // Create current message placeholder
                this.currentMessageElement = this.addMessage('sara', '', true);
                
                try {
                    // Start streaming request
                    const response = await fetch('/api/chat_stream', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ message })
                    });

                    if (!response.ok) {
                        throw new Error('Streaming failed to start');
                    }

                    // Start SSE stream
                    this.eventSource = new EventSource('/api/chat/stream');
                    this.handleStreamEvents();

                } catch (error) {
                    this.stopStreaming();
                    this.streamingStatus.textContent = '‚ùå Error';
                    this.statusText.textContent = 'Connection failed';
                }
            }

            handleStreamEvents() {
                if (!this.eventSource) return;

                this.eventSource.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        
                        switch (data.type) {
                            case 'text_chunk':
                                this.appendTextToMessage(data.content, data.is_thinking);
                                break;
                                
                            case 'thinking_start':
                                this.addThinkingIndicator();
                                break;
                                
                            case 'thinking_end':
                                this.removeThinkingIndicator();
                                break;
                                
                            case 'response_complete':
                                this.onResponseComplete();
                                break;
                                
                            case 'completion_thinking_start':
                                this.streamingStatus.textContent = 'üß† Completing thoughts...';
                                break;
                                
                            case 'completion_thinking':
                                this.addCompletion(data.content);
                                break;
                                
                            case 'stopped':
                                this.stopStreaming();
                                break;
                                
                            case 'error':
                                this.streamingStatus.textContent = '‚ùå Error';
                                this.statusText.textContent = data.content;
                                this.stopStreaming();
                                break;
                        }
                    } catch (e) {
                        console.error('Stream parse error:', e);
                    }
                };

                this.eventSource.onerror = (e) => {
                    console.error('Stream error:', e);
                    this.stopStreaming();
                };
            }

            appendTextToMessage(text, isThinking = false) {
                if (!this.currentMessageElement) return;
                
                const contentDiv = this.currentMessageElement.querySelector('.message-content');
                if (contentDiv) {
                    contentDiv.textContent += text;
                    this.scrollToBottom();
                }
            }

            addThinkingIndicator() {
                if (!this.currentMessageElement) return;
                
                const contentDiv = this.currentMessageElement.querySelector('.message-content');
                const thinkingDiv = document.createElement('div');
                thinkingDiv.className = 'thinking-indicator';
                thinkingDiv.innerHTML = `
                    <div class="thinking-dots">
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                        <div class="thinking-dot"></div>
                    </div>
                    <span>Sara is thinking...</span>
                `;
                contentDiv.appendChild(thinkingDiv);
            }

            removeThinkingIndicator() {
                if (!this.currentMessageElement) return;
                
                const thinkingIndicator = this.currentMessageElement.querySelector('.thinking-indicator');
                if (thinkingIndicator) {
                    thinkingIndicator.remove();
                }
            }

            addCompletion(additionalContent) {
                if (!this.currentMessageElement) return;
                
                const contentDiv = this.currentMessageElement.querySelector('.message-content');
                const completionDiv = document.createElement('div');
                completionDiv.className = 'completions';
                completionDiv.textContent = `üí≠ SARA: ${additionalContent}`;
                contentDiv.appendChild(completionDiv);
                this.scrollToBottom();
            }

            onResponseComplete() {
                this.isStreaming = false;
                this.sendButton.disabled = false;
                this.stopButton.disabled = true;
                this.streamingStatus.textContent = 'ü§ñ Ready';
                this.statusText.textContent = 'Sara finished responding';
                this.currentMessageElement = null;
                
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
            }

            stopResponse() {
                if (!this.isStreaming) return;
                
                // Send stop request
                fetch('/api/stop_response', { method: 'POST' });
                
                // Local cleanup
                this.stopStreaming();
            }

            stopStreaming() {
                this.isStreaming = false;
                this.sendButton.disabled = false;
                this.stopButton.disabled = true;
                this.streamingStatus.textContent = '‚èπ Stopped';
                this.statusText.textContent = 'Response interrupted';
                this.currentMessageElement = null;
                
                if (this.eventSource) {
                    this.eventSource.close();
                    this.eventSource = null;
                }
            }

            addMessage(type, content, isStreaming = false) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${type}`;
                messageDiv.style.marginBottom = type === 'user' ? '1.2rem' : '1.5rem';
                
                const avatar = document.createElement('div');
                avatar.className = `avatar ${type}`;
                avatar.textContent = type === 'user' ? 'B' : 'S';
                
                const messageContent = document.createElement('div');
                messageContent.className = 'message-content';
                messageContent.textContent = content;
                
                if (type === 'user') {
                    // User: content first, then avatar on right
                    messageDiv.appendChild(messageContent);
                    messageDiv.appendChild(avatar);
                } else {
                    // Sara: avatar first, then content on right
                    messageDiv.appendChild(avatar);
                    messageDiv.appendChild(messageContent);
                }
                
                this.messagesContainer.appendChild(messageDiv);
                this.scrollToBottom();
                
                if (type === 'sara' && isStreaming) {
                    return messageDiv; // Return for streaming updates
                }
            }

            scrollToBottom() {
                this.messagesContainer.scrollTop = this.messagesContainer.scrollHeight;
            }

            addWelcomeMessage() {
                setTimeout(() => {
                    this.addMessage('sara', "Hello Boo! I'm Sara with autonomous streaming capabilities. I'll respond naturally, think through answers completely, and can even continue thinking after my initial response. You can stop me anytime with the stop button! üíö Ready to help!");
                }, 500);
            }
        }

        // Initialize the autonomous chat
        document.addEventListener('DOMContentLoaded', () => {
            new SaraAutonomousChat();
        });
    </script>
</body>
</html>